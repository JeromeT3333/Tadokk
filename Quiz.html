<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Muscle Physiology ‚Äî 100 T/F Quiz</title>
<style>
  :root{
    --bg:#0f1724; --card:#0b1220; --accent:#48b0bf; --muted:#9aa6b2;
    --correct:#1f7a1f; --wrong:#9b2b2b; --text:#e6eef6;
  }
  :root.light{
    --bg:#f6f7fb; --card:#ffffff; --accent:#0d6efd; --muted:#3c4958;
    --correct:#1f7a1f; --wrong:#b02a37; --text:#111827;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
  .top-logo{position:fixed;top:8px;right:12px;max-height:56px;z-index:9999;width:auto}
  .wrap{max-width:980px;margin:28px auto;padding:16px;padding-top:10px}
  header{display:flex;justify-content:flex-start;align-items:center;gap:8px;margin-bottom:12px;margin-right:160px}
  h1{margin:0;font-size:1.25rem}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.45)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);min-width:220px;background:transparent;color:var(--text)}
  .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer}
  .q{display:flex;justify-content:space-between;gap:12px;padding:10px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02)}
  .qtext{flex:1}
  .choices{display:flex;gap:12px;align-items:center}
  .correct{color:var(--correct);font-weight:600}
  .wrong{color:var(--wrong);font-weight:600}
  .results{margin-top:14px;padding:12px;border-radius:8px;background:rgba(0,0,0,0.12);color:var(--text)}
  footer{text-align:center;margin-top:16px;color:var(--muted);font-size:0.95rem}
  .nav{display:flex;justify-content:space-between;align-items:center;margin-top:10px;gap:8px}
  .timer{font-weight:700;color:#fff;background:var(--accent);padding:6px 12px;border-radius:14px;margin-left:12px;transition:all 0.25s ease;box-shadow:0 4px 12px rgba(0,0,0,0.25)}
  .timer.warning{background:#b02a37}
  .timer.urgent{background:#b02a37;animation:pulse 1s infinite}
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
  .small{font-size:0.9rem;color:var(--muted)}
  @media(max-width:720px){ .choices{flex-wrap:wrap} .top-logo{max-height:44px} header{margin-right:100px} }
</style>
</head>
<body>
<img class="top-logo" src="Tadokkico1.png" alt="Tadokkico logo" id="pageLogo">
<div class="wrap">
  <header><h1>Muscle Physiology ‚Äî 100 True/False Quiz</h1></header>
  <div id="startCard" class="card">
    <div class="row">
      <input id="studentName" class="input" placeholder="Full name (required)"/>
      <input id="studentEmail" class="input" placeholder="Email (required)"/>
      <button id="startBtn" class="btn">Start Quiz</button>
      <button id="themeBtn" class="ghost">üåô Dark</button>
      <button id="shuffleBtn" class="ghost">Shuffle</button>
    </div>
    <div style="margin-top:8px" class="small">30-minute timer starts when you click <strong>Start Quiz</strong>. Refresh to restart attempt.</div>
  </div>
  <div id="quizCard" class="card" style="display:none;margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="pageinfo small">Page <span id="pageNum">1</span>/<span id="pageCount">10</span>
        <span class="timer" id="timerDisplay"></span>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="prevBtn" class="ghost">‚óÄ Prev</button>
        <button id="nextBtn" class="ghost">Next ‚ñ∂</button>
      </div>
    </div>
    <div id="quiz" style="max-height:560px;overflow:auto;padding-right:6px;margin-top:10px"></div>
    <div class="nav"><div class="small">Corrections shown on web only. PDF shows summary only.</div><div><button id="submitBtn" class="btn">Submit</button></div></div>
    <div id="results" class="results" style="display:none"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:10px;gap:8px"><button id="exportBtn" class="btn" style="display:none">Download Result!</button></div>
  </div>
  <footer>Powered by Tadokk</footer>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

<script>
(() => {
  const SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwcZ1H7uGtTIeySFGgMJIHAWppU0yqHe7ZoRUJElnMS2w36z5rZTFSQUDm7t918Bnbl/exec";
  let studentName='', studentEmail='', answers=[], timerInterval=null, timeLeft=30*60;
  const pageSize=10; let currentPage=0;

  const questions = [
{q:"Each skeletal muscle fiber is multinucleated, with nuclei located at the cell periphery.",a:true,topic:"Skeletal"},
{q:"Satellite cells drive muscle repair but do not directly contract.",a:true,topic:"Skeletal"},
{q:"Slow-twitch fibers (Type I) have more mitochondria than fast-twitch fibers.",a:true,topic:"Skeletal"},
{q:"Type IIx fibers fatigue more rapidly than Type IIa fibers.",a:true,topic:"Skeletal"},
{q:"Isometric contractions involve change in muscle length without change in tension.",a:false,topic:"Skeletal"},
{q:"In concentric contraction, the muscle shortens while generating force.",a:true,topic:"Skeletal"},
{q:"The length‚Äìtension relationship shows maximal force at optimal sarcomere length.",a:true,topic:"Skeletal"},
{q:"Muscle hypertrophy is mainly due to increase in fiber size, not number.",a:true,topic:"Skeletal"},
{q:"The ‚Äúall-or-none‚Äù principle applies to entire muscles, not individual fibers.",a:false,topic:"Skeletal"},
{q:"Complete tetanus occurs when stimuli arrive so rapidly that relaxation is impossible.",a:true,topic:"Skeletal"},
{q:"The force‚Äìvelocity curve shows greater load decreases contraction velocity.",a:true,topic:"Skeletal"},
{q:"Myoglobin content is higher in slow oxidative fibers.",a:true,topic:"Skeletal"},
{q:"Creatine phosphate is the first energy store tapped during rapid contraction.",a:true,topic:"Skeletal"},
{q:"Muscle tone results from partial activation of motor units at rest.",a:true,topic:"Skeletal"},
{q:"Muscle spindles detect changes in length and speed of stretch.",a:true,topic:"Skeletal"},
{q:"Golgi tendon organs monitor muscle tension and prevent overloading.",a:true,topic:"Skeletal"},
{q:"Recruitment of motor units follows the size principle.",a:true,topic:"Skeletal"},
{q:"Cross-bridge cycling requires ATP binding for detachment.",a:true,topic:"Skeletal"},
{q:"Rigor mortis occurs because ATP is absent, preventing cross-bridge detachment.",a:true,topic:"Skeletal"},
{q:"Excitation‚Äìcontraction coupling in skeletal muscle depends on extracellular calcium entry.",a:false,topic:"Skeletal"},
{q:"Cardiac muscle fibers are branched and connected by intercalated discs.",a:true,topic:"Cardiac"},
{q:"Gap junctions allow rapid spread of action potentials in cardiac muscle.",a:true,topic:"Cardiac"},
{q:"Pacemaker potential is primarily due to ‚Äúfunny‚Äù Na‚Å∫ currents (If).",a:true,topic:"Cardiac"},
{q:"Phase 0 of the ventricular action potential is mediated by fast Na‚Å∫ channels.",a:true,topic:"Cardiac"},
{q:"The plateau phase is sustained by L-type calcium channel influx.",a:true,topic:"Cardiac"},
{q:"Cardiac muscle can undergo tetanus due to long refractory period.",a:false,topic:"Cardiac"},
{q:"The Frank‚ÄìStarling law relates end-diastolic volume to stroke volume.",a:true,topic:"Cardiac"},
{q:"Beta-adrenergic stimulation increases heart rate and contractility.",a:true,topic:"Cardiac"},
{q:"The AV node slows conduction to permit ventricular filling.",a:true,topic:"Cardiac"},
{q:"Ischemia forces cardiac muscle to rely more on anaerobic glycolysis.",a:true,topic:"Cardiac"},
{q:"Cardiac troponin is a clinical marker of myocardial injury.",a:true,topic:"Cardiac"},
{q:"Potassium efflux contributes to repolarization of cardiac myocytes.",a:true,topic:"Cardiac"},
{q:"Excess extracellular K‚Å∫ can increase cardiac excitability.",a:false,topic:"Cardiac"},
{q:"The Purkinje system conducts impulses faster than the AV node.",a:true,topic:"Cardiac"},
{q:"Conduction velocity is lowest at the AV node.",a:true,topic:"Cardiac"},
{q:"Sympathetic stimulation increases slope of pacemaker depolarization.",a:true,topic:"Cardiac"},
{q:"Cardiac muscle contraction is calcium-dependent via Ca¬≤‚Å∫-induced Ca¬≤‚Å∫ release.",a:true,topic:"Cardiac"},
{q:"Ventricular fibrillation maintains cardiac output due to uncoordinated contractions.",a:false,topic:"Cardiac"},
{q:"Calcium channel blockers reduce contractility by decreasing calcium influx.",a:true,topic:"Cardiac"},
{q:"Unlike skeletal muscle, cardiac excitation‚Äìcontraction coupling requires extracellular calcium.",a:true,topic:"Cardiac"},
{q:"Smooth muscle lacks sarcomeres but contains actin and myosin filaments.",a:true,topic:"Smooth"},
{q:"Dense bodies in smooth muscle act like Z-discs in skeletal muscle.",a:true,topic:"Smooth"},
{q:"Contraction in smooth muscle is regulated by MLCK and Ca¬≤‚Å∫-calmodulin.",a:true,topic:"Smooth"},
{q:"Troponin is absent in smooth muscle.",a:true,topic:"Smooth"},
{q:"Smooth muscle can maintain tone with minimal ATP use via latch state.",a:true,topic:"Smooth"},
{q:"Single-unit smooth muscle is electrically coupled via gap junctions.",a:true,topic:"Smooth"},
{q:"Multi-unit smooth muscle fibers contract independently.",a:true,topic:"Smooth"},
{q:"Rho-kinase increases contraction by inhibiting myosin light-chain phosphatase.",a:true,topic:"Smooth"},
{q:"Smooth muscle contracts more quickly but fatigues faster than skeletal muscle.",a:false,topic:"Smooth"},
{q:"Hormones such as oxytocin can regulate smooth muscle tone.",a:true,topic:"Smooth"},
{q:"Nitric oxide relaxes smooth muscle by increasing cGMP.",a:true,topic:"Smooth"},
{q:"Smooth muscle contraction depends partly on extracellular calcium entry.",a:true,topic:"Smooth"},
{q:"Peristalsis is mediated by coordinated smooth muscle contraction.",a:true,topic:"Smooth"},
{q:"Adrenergic stimulation always relaxes smooth muscle regardless of receptor subtype.",a:false,topic:"Smooth"},
{q:"Smooth muscle can undergo hypertrophy and hyperplasia.",a:true,topic:"Smooth"},
{q:"Calcium sparks from the sarcoplasmic reticulum regulate local contraction.",a:true,topic:"Smooth"},
{q:"Pharmacomechanical coupling in smooth muscle does not require action potentials.",a:true,topic:"Smooth"},
{q:"Myosin light chain phosphorylation is essential for initiating contraction.",a:true,topic:"Smooth"},
{q:"Gap junctions facilitate coordinated contraction in visceral smooth muscle.",a:true,topic:"Smooth"},
{q:"Some smooth muscles exhibit pacemaker activity.",a:true,topic:"Smooth"},
{q:"At the neuromuscular junction, acetylcholine binds nicotinic receptors.",a:true,topic:"NMJ"},
{q:"End-plate potentials are usually sufficient to trigger action potentials.",a:true,topic:"NMJ"},
{q:"Botulinum toxin prevents ACh release by cleaving SNARE proteins.",a:true,topic:"NMJ"},
{q:"Myasthenia gravis involves antibodies against postsynaptic ACh receptors.",a:true,topic:"NMJ"},
{q:"Lambert-Eaton syndrome involves antibodies against presynaptic calcium channels.",a:true,topic:"NMJ"},
{q:"Acetylcholinesterase rapidly breaks down ACh in the synaptic cleft.",a:true,topic:"NMJ"},
{q:"Denervation hypersensitivity increases extrajunctional receptors.",a:true,topic:"NMJ"},
{q:"Curare blocks nicotinic receptors, preventing depolarization.",a:true,topic:"NMJ"},
{q:"Succinylcholine causes depolarizing neuromuscular blockade.",a:true,topic:"NMJ"},
{q:"Quantal release refers to vesicles releasing fixed amounts of ACh.",a:true,topic:"NMJ"},
{q:"Skeletal muscle action potentials rely on sodium influx.",a:true,topic:"NMJ"},
{q:"The DHP receptor in skeletal muscle acts as a voltage sensor.",a:true,topic:"EC"},
{q:"Calcium release from the sarcoplasmic reticulum occurs via RyR channels.",a:true,topic:"EC"},
{q:"SERCA pumps resequester calcium into the SR.",a:true,topic:"EC"},
{q:"Phospholamban regulates SERCA activity in cardiac muscle.",a:true,topic:"EC"},
{q:"CICR is the dominant coupling mechanism in cardiac muscle.",a:true,topic:"EC"},
{q:"RyR leak can cause muscle weakness.",a:true,topic:"EC"},
{q:"T-tubules ensure synchronous activation of muscle fibers.",a:true,topic:"EC"},
{q:"The plateau of cardiac AP is due to balance between Ca¬≤‚Å∫ influx and K‚Å∫ efflux.",a:true,topic:"EC"},
{q:"Na‚Å∫/Ca¬≤‚Å∫ exchanger helps remove calcium from cardiac cells.",a:true,topic:"EC"},
{q:"Oxidative phosphorylation yields ~36 ATP per glucose.",a:true,topic:"Energy"},
{q:"Anaerobic glycolysis yields only 2 ATP per glucose.",a:true,topic:"Energy"},
{q:"Phosphocreatine provides rapid ATP regeneration.",a:true,topic:"Energy"},
{q:"Fatigue during prolonged activity is linked to glycogen depletion.",a:true,topic:"Energy"},
{q:"Lactate can be converted back to glucose in the liver.",a:true,topic:"Energy"},
{q:"Endurance training increases mitochondrial density.",a:true,topic:"Energy"},
{q:"Sprint performance relies primarily on anaerobic glycolysis.",a:true,topic:"Energy"},
{q:"Fatty acids are the major fuel during prolonged submaximal exercise.",a:true,topic:"Energy"},
{q:"AMPK activation promotes energy conservation.",a:true,topic:"Energy"},
{q:"VO‚ÇÇmax depends on both delivery and utilization of oxygen.",a:true,topic:"Energy"},
{q:"Duchenne muscular dystrophy is due to dystrophin gene mutation.",a:true,topic:"Disease"},
{q:"Becker muscular dystrophy is milder due to partially functional dystrophin.",a:true,topic:"Disease"},
{q:"Rhabdomyolysis releases myoglobin that can damage kidneys.",a:true,topic:"Disease"},
{q:"Malignant hyperthermia involves uncontrolled SR Ca¬≤‚Å∫ release.",a:true,topic:"Disease"},
{q:"Statins can cause myopathy in some patients.",a:true,topic:"Disease"},
{q:"Myotonic dystrophy involves delayed relaxation due to ion channel defects.",a:true,topic:"Disease"},
{q:"Botulism causes flaccid paralysis.",a:true,topic:"Disease"},
{q:"Hypokalemia can cause muscle weakness.",a:true,topic:"Disease"},
{q:"Hyperkalemia can impair cardiac muscle function.",a:true,topic:"Disease"},
{q:"Polymyositis is an inflammatory myopathy mediated by immune cells.",a:true,topic:"Disease"}
  ];

  // DOM refs
  const startCard = document.getElementById('startCard');
  const quizCard = document.getElementById('quizCard');
  const quizDiv = document.getElementById('quiz');
  const startBtn = document.getElementById('startBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const submitBtn = document.getElementById('submitBtn');
  const resultsDiv = document.getElementById('results');
  const exportBtn = document.getElementById('exportBtn');
  const shuffleBtn = document.getElementById('shuffleBtn');
  const themeBtn = document.getElementById('themeBtn');
  const pageNumSpan = document.getElementById('pageNum');
  const pageCountSpan = document.getElementById('pageCount');
  const timerDisplay = document.getElementById('timerDisplay');
  const pageLogo = document.getElementById('pageLogo');

  pageCountSpan.textContent = Math.ceil(questions.length / pageSize);

  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function sanitizeFilename(n){ return (n||'student').replace(/[^a-z0-9_\-]/ig,'_').slice(0,40); }

  function shuffleArray(arr){
    for (let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function renderPage(page = 0){
    quizDiv.innerHTML = '';
    const start = page * pageSize;
    const slice = questions.slice(start, start + pageSize);
    slice.forEach((item, idx) => {
      const index = start + idx;
      const div = document.createElement('div');
      div.className = 'q';
      div.innerHTML = `
        <div class="qtext"><strong>Q${index+1}.</strong> ${escapeHtml(item.q)}</div>
        <div class="choices">
          <label><input type="radio" name="q${index}" value="true" ${answers[index]==='true'?'checked':''}> True</label>
          <label><input type="radio" name="q${index}" value="false" ${answers[index]==='false'?'checked':''}> False</label>
        </div>
      `;
      quizDiv.appendChild(div);
      div.querySelectorAll('input[type=radio]').forEach(r=>r.addEventListener('change', e=>{ answers[index] = e.target.value; }));
    });
    prevBtn.disabled = page === 0;
    nextBtn.disabled = page === Math.ceil(questions.length / pageSize) - 1;
    pageNumSpan.textContent = page + 1;
    quizDiv.scrollTop = 0;
  }

  function startTimer(){
    clearInterval(timerInterval);
    timeLeft = 30 * 60;
    updateTimer();
    timerInterval = setInterval(()=>{
      timeLeft--;
      updateTimer();
      if (timeLeft <= 0){ clearInterval(timerInterval); submitQuiz(true); }
    },1000);
  }

  function updateTimer(){
    const mm = String(Math.floor(timeLeft/60)).padStart(2,'0');
    const ss = String(timeLeft%60).padStart(2,'0');
    timerDisplay.textContent = `‚è± ${mm}:${ss}`;
    timerDisplay.classList.remove('warning','urgent');
    if (timeLeft <= 300) timerDisplay.classList.add('warning');
    if (timeLeft <= 60) timerDisplay.classList.add('urgent');
  }

  startBtn.addEventListener('click', ()=>{
    const name = (document.getElementById('studentName').value || '').trim();
    const email = (document.getElementById('studentEmail').value || '').trim();
    if (!name){ alert('Please enter your full name'); return; }
    if (!email || !email.includes('@')){ alert('Please enter a valid email'); return; }
    studentName = name; studentEmail = email;
    answers = Array(questions.length).fill(null);
    shuffleArray(questions);
    startCard.style.display = 'none'; quizCard.style.display = 'block'; currentPage = 0; renderPage(currentPage);
    resultsDiv.style.display = 'none'; exportBtn.style.display = 'none';
    startTimer();
  });

  prevBtn.addEventListener('click', ()=>{ if (currentPage > 0){ currentPage--; renderPage(currentPage); } });
  nextBtn.addEventListener('click', ()=>{ if (currentPage < Math.ceil(questions.length/pageSize)-1){ currentPage++; renderPage(currentPage); } });

  shuffleBtn.addEventListener('click', ()=>{
    shuffleArray(questions);
    answers = Array(questions.length).fill(null);
    currentPage = 0;
    renderPage(currentPage);
    resultsDiv.style.display = 'none'; exportBtn.style.display = 'none';
  });

  themeBtn.addEventListener('click', ()=>{
    document.documentElement.classList.toggle('light');
    themeBtn.textContent = document.documentElement.classList.contains('light') ? '‚òÄÔ∏è Light' : 'üåô Dark';
  });

  function submitQuiz(isAuto=false){
    clearInterval(timerInterval);
    const feedback=[]; let correct=0; const topicStats={};
    for (let i=0;i<questions.length;i++){
      const expected = questions[i].a ? 'true' : 'false';
      const given = answers[i] || null;
      const isCorrect = given === expected;
      if (isCorrect) correct++;
      const t = questions[i].topic || 'General';
      if (!topicStats[t]) topicStats[t] = {total:0,wrong:0};
      topicStats[t].total++; if (!isCorrect) topicStats[t].wrong++;
      feedback.push({i, q: questions[i].q, given, expected, isCorrect});
    }
    const percent = Math.round((correct/questions.length)*100);
    let focusAreas = Object.entries(topicStats).map(([t,v])=>({topic:t,missed:v.wrong,total:v.total})).filter(x=>x.missed>0);
    focusAreas.sort((a,b)=> a.missed - b.missed );
    let html = `<h3>Results ‚Äî ${escapeHtml(studentName)}</h3>`;
    html += `<p><strong>Email:</strong> ${escapeHtml(studentEmail)}</p>`;
    html += `<p><strong>Score:</strong> ${correct} / ${questions.length} (${percent}%)</p>`;
    if (focusAreas.length === 0) html += `<p>Excellent ‚Äî no topic misses detected.</p>`;
    else { html += `<p><strong>Focus areas (weaker topics shown last):</strong></p><ul>`; focusAreas.forEach(f=> html += `<li>${escapeHtml(f.topic)} ‚Äî missed ${f.missed} / ${f.total}</li>`); html += `</ul>`; }
    html += `<h4>Corrections (web only)</h4>`;
    feedback.forEach(f=> html += `<div class="${f.isCorrect?'correct':'wrong'}">Q${f.i+1}. ${escapeHtml(f.q)}<br>Your: ${f.given||'No answer'} | Correct: ${f.expected}</div>`);
    resultsDiv.innerHTML = html; resultsDiv.style.display = 'block'; exportBtn.style.display = 'inline-block';
    window.__tadokk_last_report = { name: studentName, email: studentEmail, score: correct, total: questions.length, percent, focusAreas };
    try{ sendToSheets(window.__tadokk_last_report); }catch(e){ console.warn('Sheets send error', e); }
    setTimeout(()=>{ try{ generateAndDownloadReport(window.__tadokk_last_report); }catch(e){ console.error('Auto-download failed', e); } }, 600);
    if (!isAuto) resultsDiv.scrollIntoView({behavior:'smooth'});
  }

  submitBtn.addEventListener('click', ()=> submitQuiz(false));

  function sendToSheets(report){
    const payload = { name: report.name, email: report.email, score: report.score, percent: report.percent, focusAreas: (report.focusAreas||[]).map(f=>f.topic||f) };
    fetch(SHEET_WEBAPP_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    }).then(r=> r.text().then(t=> console.log('Sheets response', r.status, t)) )
      .catch(err=>{ console.warn('Sheets send failed, fallback no-cors', err); try{ fetch(SHEET_WEBAPP_URL, { method:'POST', mode:'no-cors', body: JSON.stringify(payload) }); }catch(e){} });
  }

  function imageElementToDataUrl(imgEl){
    return new Promise((resolve)=>{
      try {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          try {
            const c = document.createElement('canvas');
            c.width = img.naturalWidth;
            c.height = img.naturalHeight;
            const ctx = c.getContext('2d');
            ctx.drawImage(img,0,0);
            resolve(c.toDataURL('image/png'));
          } catch(e) { console.warn('Canvas draw failed', e); resolve(null); }
        };
        img.onerror = ()=> { console.warn('Could not load image for embedding'); resolve(null); };
        img.src = imgEl.src || 'Tadokkico1.png';
      } catch(e){ console.warn('imageElementToDataUrl error', e); resolve(null); }
    });
  }

  async function generateAndDownloadReport(r){
    if (!window.jspdf){ console.warn('jsPDF not loaded'); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'pt',format:'a4'});
    const brand = [0,86,179];
    doc.setFontSize(18); doc.setTextColor(...brand);
    doc.text('Muscle Physiology Quiz Report',40,60);
    doc.setFontSize(11); doc.setTextColor(0,0,0);
    doc.text(`Name: ${r.name}`,40,86);
    doc.text(`Email: ${r.email}`,40,104);
    doc.text(`Date: ${new Date().toLocaleString()}`,40,122);
    doc.text(`Score: ${r.score} / ${r.total} (${r.percent}%)`,40,140);
    const tableData = (r.focusAreas || []).map(f => [f.topic, `${f.total}`, `${f.missed}`, `${f.total - f.missed}`]);
    let startY = 162;
    if (tableData.length > 0) {
      doc.autoTable({
        startY,
        head: [['Topic','Total Questions','Wrong','Correct']],
        body: tableData,
        theme: 'striped',
        styles: { fontSize: 10 },
        headStyles: { fillColor: brand, textColor: 255, halign: 'center' },
        alternateRowStyles: { fillColor: [230, 245, 255] },
        columnStyles: { 0: { cellWidth: 240 }, 1: { halign: 'center' }, 2: { halign: 'center' }, 3: { halign: 'center' } }
      });
      startY = doc.lastAutoTable.finalY + 10;
    } else {
      doc.text('Focus Areas: None ‚Äî excellent performance.', 40, startY);
    }
    const imgData = await imageElementToDataUrl(document.getElementById('pageLogo'));
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const logoW = 150;
    let logoH = 50;
    if (imgData){
      const tmp = new Image();
      tmp.src = imgData;
      await new Promise((res)=>{ tmp.onload = res; tmp.onerror = res; });
      const ar = (tmp.naturalHeight && tmp.naturalWidth) ? (tmp.naturalHeight / tmp.naturalWidth) : 0.4;
      logoH = Math.max(30, Math.round(logoW * ar));
      try{ doc.addImage(imgData, 'PNG', pageW - logoW - 40, 30, logoW, logoH); }catch(e){ console.warn('addImage failed', e); }
    }
    doc.setDrawColor(...brand); doc.setLineWidth(0.6);
    doc.line(40, pageH - 80, pageW - 40, pageH - 80);
    doc.setFontSize(10); doc.setTextColor(0,0,0);
    doc.text('Powered by Tadokk', 40, pageH - 60);
    const filename = `Tadokk_QuizReport_${sanitizeFilename(r.name)}_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`;
    doc.save(filename);
  }

  exportBtn.addEventListener('click', ()=> { const r = window.__tadokk_last_report; if (!r) return alert('Submit first to download your result.'); generateAndDownloadReport(r); });

  renderPage(0);
})(); 
</script>
</body>
</html>
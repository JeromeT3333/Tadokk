<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Muscle Physiology ‚Äî 100 T/F Quiz (Simplified)</title>
<style>
  :root{--bg:#0f1724;--card:#0b1220;--accent:#48b0bf;--muted:#9aa6b2;--correct:#1f7a1f;--wrong:#9b2b2b;--text:#e6eef6}
  :root.light{--bg:#f6f7fb;--card:#ffffff;--accent:#0d6efd;--muted:#3c4958;--correct:#1f7a1f;--wrong:#b02a37;--text:#111827}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
  .top-logo{position:fixed;top:8px;right:12px;max-height:56px;z-index:9999;width:auto}
  .wrap{max-width:980px;margin:28px auto;padding:16px;padding-top:10px}
  header{display:flex;justify-content:flex-start;align-items:center;gap:8px;margin-bottom:12px;margin-right:160px}
  h1{margin:0;font-size:1.25rem}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.45)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);min-width:220px;background:transparent;color:var(--text)}
  .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer}
  .q{display:flex;justify-content:space-between;gap:12px;padding:10px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02)}
  .qtext{flex:1}
  .choices{display:flex;gap:12px;align-items:center}
  .correct{color:var(--correct);font-weight:600}
  .wrong{color:var(--wrong);font-weight:600}
  .results{margin-top:14px;padding:12px;border-radius:8px;background:rgba(0,0,0,0.12);color:var(--text)}
  footer{text-align:center;margin-top:16px;color:var(--muted);font-size:0.95rem}
  .nav{display:flex;justify-content:space-between;align-items:center;margin-top:10px;gap:8px}
  .timer{font-weight:700;color:#fff;background:var(--accent);padding:6px 12px;border-radius:14px;margin-left:12px;transition:all 0.25s ease;box-shadow:0 4px 12px rgba(0,0,0,0.25)}
  .timer.warning{background:#b02a37}
  .timer.urgent{background:#b02a37;animation:pulse 1s infinite}
  @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
  .small{font-size:0.9rem;color:var(--muted)}
  @media(max-width:720px){ .choices{flex-wrap:wrap} .top-logo{max-height:44px} header{margin-right:100px} }
</style>
</head>
<body>
<img class="top-logo" src="Tadokkico1.png" alt="Tadokkico logo" id="pageLogo">
<div class="wrap">
  <header><h1>Muscle Physiology ‚Äî 100 True/False Quiz</h1></header>
  <div id="startCard" class="card">
    <div class="row">
      <input id="studentName" class="input" placeholder="Full name (required)"/>
      <input id="studentEmail" class="input" placeholder="Email (required)"/>
      <button id="startBtn" class="btn">Start Quiz</button>
      <button id="themeBtn" class="ghost">üåô Dark</button>
      <button id="shuffleBtn" class="ghost">Shuffle</button>
    </div>
    <div style="margin-top:8px" class="small">30-minute timer starts when you click <strong>Start Quiz</strong>. Refresh to restart attempt.</div>
  </div>

  <div id="quizCard" class="card" style="display:none;margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="pageinfo small">Page <span id="pageNum">1</span>/<span id="pageCount">10</span>
        <span class="timer" id="timerDisplay"></span>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="prevBtn" class="ghost">‚óÄ Prev</button>
        <button id="nextBtn" class="ghost">Next ‚ñ∂</button>
      </div>
    </div>
    <div id="quiz" style="max-height:560px;overflow:auto;padding-right:6px;margin-top:10px"></div>
    <div class="nav"><div class="small">Corrections shown on web only. PDF shows summary only.</div><div><button id="submitBtn" class="btn">Submit</button></div></div>
    <div id="results" class="results" style="display:none"></div>
    <div style="display:flex;justify-content:flex-end;margin-top:10px;gap:8px"><button id="exportBtn" class="btn" style="display:none">Download Result!</button></div>
  </div>
  <footer>Powered by Tadokk</footer>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

<script>
(() => {
  // Keep Sheets URL if you want; user previously asked to keep integration.
  const SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwcZ1H7uGtTIeySFGgMJIHAWppU0yqHe7ZoRUJElnMS2w36z5rZTFSQUDm7t918Bnbl/exec";

  let studentName='', studentEmail='', answers=[], timerInterval=null, timeLeft=30*60;
  const pageSize=10; let currentPage=0;

  // === Simplified 100 questions taken directly from the user's material ===
  const questions = [
// Skeletal 1-20
{q:"Each skeletal muscle fiber contains multiple nuclei at its periphery.",a:true,topic:"Skeletal"},
{q:"Satellite cells participate in muscle repair.",a:true,topic:"Skeletal"},
{q:"Slow-twitch (type I) fibers have many mitochondria.",a:true,topic:"Skeletal"},
{q:"Type IIx fibers fatigue slower than Type IIa.",a:false,topic:"Skeletal"},
{q:"Isometric contraction changes muscle length.",a:false,topic:"Skeletal"},
{q:"Concentric contraction shortens a muscle while it generates force.",a:true,topic:"Skeletal"},
{q:"Optimal sarcomere length yields maximal force.",a:true,topic:"Skeletal"},
{q:"Hypertrophy increases fiber size more than fiber number.",a:true,topic:"Skeletal"},
{q:"The all-or-none law applies to individual muscle fibers.",a:true,topic:"Skeletal"},
{q:"Tetanus happens if stimuli arrive too quickly for relaxation.",a:true,topic:"Skeletal"},
{q:"Higher load generally reduces shortening velocity.",a:true,topic:"Skeletal"},
{q:"Myoglobin concentration is greater in slow oxidative fibers.",a:true,topic:"Skeletal"},
{q:"Phosphocreatine is used first during a very short burst of activity.",a:true,topic:"Skeletal"},
{q:"Muscle tone arises from partial activation of motor units at rest.",a:true,topic:"Skeletal"},
{q:"Muscle spindles sense changes in muscle length.",a:true,topic:"Skeletal"},
{q:"Golgi tendon organs sense tension in tendons.",a:true,topic:"Skeletal"},
{q:"Smaller motor units are recruited before larger ones (size principle).",a:true,topic:"Skeletal"},
{q:"ATP is required for detachment of myosin from actin.",a:true,topic:"Skeletal"},
{q:"Rigor mortis results from lack of ATP preventing crossbridge release.",a:true,topic:"Skeletal"},
{q:"Extracellular calcium entry is required to trigger SR release in skeletal muscle.",a:false,topic:"Skeletal"},

// Cardiac 21-40
{q:"Cardiac muscle fibers are connected by intercalated discs.",a:true,topic:"Cardiac"},
{q:"Gap junctions allow electrical coupling between cardiac cells.",a:true,topic:"Cardiac"},
{q:"If (funny) currents contribute to pacemaker activity.",a:true,topic:"Cardiac"},
{q:"Fast sodium channels mediate rapid upstroke in ventricular myocytes.",a:true,topic:"Cardiac"},
{q:"L-type calcium channels contribute to the plateau phase.",a:true,topic:"Cardiac"},
{q:"Cardiac muscle cannot sustain tetanus due to a long refractory period.",a:true,topic:"Cardiac"},
{q:"Stroke volume increases with larger end-diastolic volume (Frank‚ÄìStarling).",a:true,topic:"Cardiac"},
{q:"Beta-adrenergic stimulation increases heart rate.",a:true,topic:"Cardiac"},
{q:"The AV node delays conduction to allow ventricular filling.",a:true,topic:"Cardiac"},
{q:"Ischemic heart muscle shifts to anaerobic metabolism.",a:true,topic:"Cardiac"},
{q:"Cardiac troponin is a marker of myocardial injury.",a:true,topic:"Cardiac"},
{q:"Potassium currents help repolarize cardiac cells.",a:true,topic:"Cardiac"},
{q:"High extracellular potassium always increases excitability.",a:false,topic:"Cardiac"},
{q:"Purkinje fibers conduct faster than AV nodal tissue.",a:true,topic:"Cardiac"},
{q:"AV node has slower conduction velocity than atrial muscle.",a:true,topic:"Cardiac"},
{q:"Sympathetic input increases the slope of pacemaker depolarization.",a:true,topic:"Cardiac"},
{q:"Cardiac ECC involves calcium-induced calcium release.",a:true,topic:"Cardiac"},
{q:"Ventricular fibrillation stops effective cardiac output.",a:true,topic:"Cardiac"},
{q:"Calcium channel blockers reduce cardiac contractility.",a:true,topic:"Cardiac"},
{q:"Cardiac excitation requires extracellular calcium to trigger SR release.",a:true,topic:"Cardiac"},

// Smooth 41-60
{q:"Smooth muscle does not have sarcomeres but contains actin and myosin.",a:true,topic:"Smooth"},
{q:"Dense bodies anchor actin in smooth muscle.",a:true,topic:"Smooth"},
{q:"MLCK activated by Ca2+-calmodulin initiates contraction in smooth muscle.",a:true,topic:"Smooth"},
{q:"Troponin is not present in smooth muscle.",a:true,topic:"Smooth"},
{q:"Smooth muscle can maintain tone with low ATP via a latch state.",a:true,topic:"Smooth"},
{q:"Single-unit smooth muscle cells are electrically coupled.",a:true,topic:"Smooth"},
{q:"Multi-unit smooth muscle acts independently.",a:true,topic:"Smooth"},
{q:"Rho-kinase can increase smooth muscle contraction.",a:true,topic:"Smooth"},
{q:"Smooth muscle generally contracts faster than skeletal muscle.",a:false,topic:"Smooth"},
{q:"Hormonal signals like oxytocin affect smooth muscle tone.",a:true,topic:"Smooth"},
{q:"Nitric oxide causes smooth muscle relaxation via cGMP.",a:true,topic:"Smooth"},
{q:"Extracellular calcium contributes to smooth muscle contraction.",a:true,topic:"Smooth"},
{q:"Peristalsis involves coordinated smooth muscle contraction.",a:true,topic:"Smooth"},
{q:"Adrenergic effects on smooth muscle depend on receptor subtype.",a:true,topic:"Smooth"},
{q:"Smooth muscle can grow by hyperplasia as well as hypertrophy.",a:true,topic:"Smooth"},
{q:"Calcium sparks are local SR release events affecting smooth muscle.",a:true,topic:"Smooth"},
{q:"Smooth muscle can contract without action potentials (pharmacomechanical coupling).",a:true,topic:"Smooth"},
{q:"Myosin light chain phosphorylation is required to start contraction.",a:true,topic:"Smooth"},
{q:"Gap junctions help coordinate visceral smooth muscle.",a:true,topic:"Smooth"},
{q:"Some smooth muscles have intrinsic pacemaker activity.",a:true,topic:"Smooth"},

// Excitation-contraction & NMJ 61-80
{q:"Acetylcholine binds nicotinic receptors at the NMJ.",a:true,topic:"NMJ"},
{q:"End-plate potentials usually trigger muscle action potentials.",a:true,topic:"NMJ"},
{q:"Botulinum toxin blocks ACh release by cleaving SNARE proteins.",a:true,topic:"NMJ"},
{q:"Myasthenia gravis targets postsynaptic ACh receptors.",a:true,topic:"NMJ"},
{q:"Lambert‚ÄìEaton syndrome targets presynaptic calcium channels.",a:true,topic:"NMJ"},
{q:"Acetylcholinesterase breaks down ACh in the synaptic cleft.",a:true,topic:"NMJ"},
{q:"Denervation increases extrajunctional ACh receptors (hypersensitivity).",a:true,topic:"NMJ"},
{q:"Curare blocks nicotinic receptors preventing depolarization.",a:true,topic:"NMJ"},
{q:"Succinylcholine produces a depolarizing block at the NMJ.",a:true,topic:"NMJ"},
{q:"Quantal release means fixed amounts of ACh per vesicle.",a:true,topic:"NMJ"},
{q:"Skeletal muscle action potentials depend on sodium influx.",a:true,topic:"EC"},
{q:"DHP receptors act as voltage sensors in skeletal muscle.",a:true,topic:"EC"},
{q:"Ryanodine receptors mediate SR calcium release.",a:true,topic:"EC"},
{q:"SERCA pumps return calcium to the SR after contraction.",a:true,topic:"EC"},
{q:"Phospholamban modulates SERCA in cardiac muscle.",a:true,topic:"EC"},
{q:"Calcium-induced-calcium-release is central in cardiac ECC.",a:true,topic:"EC"},
{q:"Leaky ryanodine receptors can lead to muscle weakness.",a:true,topic:"EC"},
{q:"T-tubules help synchronize release of calcium across fibers.",a:true,topic:"EC"},
{q:"Cardiac action potential plateau balances Ca2+ influx and K+ efflux.",a:true,topic:"EC"},
{q:"Na+/Ca2+ exchanger helps remove calcium from cardiac cells.",a:true,topic:"EC"},

// Energy & Metabolism 81-90
{q:"Oxidative phosphorylation produces far more ATP than glycolysis.",a:true,topic:"Energy"},
{q:"Anaerobic glycolysis yields only 2 ATP per glucose.",a:true,topic:"Energy"},
{q:"Phosphocreatine rapidly regenerates ATP during brief activity.",a:true,topic:"Energy"},
{q:"Glycogen depletion contributes to fatigue during long exercise.",a:true,topic:"Energy"},
{q:"Lactate can be converted back to glucose by the liver.",a:true,topic:"Energy"},
{q:"Endurance training increases mitochondrial content in muscle.",a:true,topic:"Energy"},
{q:"Sprinting relies more on anaerobic metabolism than endurance.",a:true,topic:"Energy"},
{q:"Fatty acids are main fuel during prolonged moderate exercise.",a:true,topic:"Energy"},
{q:"AMPK activation promotes energy-conserving pathways.",a:true,topic:"Energy"},
{q:"VO2max depends on oxygen delivery and utilization.",a:true,topic:"Energy"},

// Disease & Clinical 91-100
{q:"Duchenne muscular dystrophy is caused by dystrophin mutation.",a:true,topic:"Disease"},
{q:"Becker dystrophy is a milder form of dystrophinopathy.",a:true,topic:"Disease"},
{q:"Rhabdomyolysis releases myoglobin that can harm kidneys.",a:true,topic:"Disease"},
{q:"Malignant hyperthermia involves uncontrolled SR calcium release.",a:true,topic:"Disease"},
{q:"Statin therapy can sometimes cause myopathy.",a:true,topic:"Disease"},
{q:"Myotonic dystrophy causes delayed muscle relaxation.",a:true,topic:"Disease"},
{q:"Botulism causes flaccid paralysis by blocking ACh release.",a:true,topic:"Disease"},
{q:"Low potassium (hypokalemia) may cause muscle weakness.",a:true,topic:"Disease"},
{q:"High potassium (hyperkalemia) can impair cardiac function.",a:true,topic:"Disease"},
{q:"Polymyositis is an immune-mediated inflammatory myopathy.",a:true,topic:"Disease"}
  ];

  // DOM refs
  const startCard = document.getElementById('startCard');
  const quizCard = document.getElementById('quizCard');
  const quizDiv = document.getElementById('quiz');
  const startBtn = document.getElementById('startBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const submitBtn = document.getElementById('submitBtn');
  const resultsDiv = document.getElementById('results');
  const exportBtn = document.getElementById('exportBtn');
  const shuffleBtn = document.getElementById('shuffleBtn');
  const themeBtn = document.getElementById('themeBtn');
  const pageNumSpan = document.getElementById('pageNum');
  const pageCountSpan = document.getElementById('pageCount');
  const timerDisplay = document.getElementById('timerDisplay');
  const pageLogo = document.getElementById('pageLogo');

  pageCountSpan.textContent = Math.ceil(questions.length / pageSize);

  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function sanitizeFilename(n){ return (n||'student').replace(/[^a-z0-9_\\-]/ig,'_').slice(0,40); }

  function shuffleArray(arr){
    for (let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function renderPage(page = 0){
    quizDiv.innerHTML = '';
    const start = page * pageSize;
    const slice = questions.slice(start, start + pageSize);
    slice.forEach((item, idx) => {
      const index = start + idx;
      const div = document.createElement('div');
      div.className = 'q';
      div.innerHTML = `
        <div class="qtext"><strong>Q${index+1}.</strong> ${escapeHtml(item.q)}</div>
        <div class="choices">
          <label><input type="radio" name="q${index}" value="true" ${answers[index]==='true'?'checked':''}> True</label>
          <label><input type="radio" name="q${index}" value="false" ${answers[index]==='false'?'checked':''}> False</label>
        </div>
      `;
      quizDiv.appendChild(div);
      div.querySelectorAll('input[type=radio]').forEach(r=>r.addEventListener('change', e=>{ answers[index] = e.target.value; }));
    });
    prevBtn.disabled = page === 0;
    nextBtn.disabled = page === Math.ceil(questions.length / pageSize) - 1;
    pageNumSpan.textContent = page + 1;
    quizDiv.scrollTop = 0;
  }

  function startTimer(){
    clearInterval(timerInterval);
    timeLeft = 30 * 60;
    updateTimer();
    timerInterval = setInterval(()=>{
      timeLeft--;
      updateTimer();
      if (timeLeft <= 0){ clearInterval(timerInterval); submitQuiz(true); }
    },1000);
  }

  function updateTimer(){
    const mm = String(Math.floor(timeLeft/60)).padStart(2,'0');
    const ss = String(timeLeft%60).padStart(2,'0');
    timerDisplay.textContent = `‚è± ${mm}:${ss}`;
    timerDisplay.classList.remove('warning','urgent');
    if (timeLeft <= 300) timerDisplay.classList.add('warning');
    if (timeLeft <= 60) timerDisplay.classList.add('urgent');
  }

  startBtn.addEventListener('click', ()=>{
    const name = (document.getElementById('studentName').value || '').trim();
    const email = (document.getElementById('studentEmail').value || '').trim();
    if (!name){ alert('Please enter your full name'); return; }
    if (!email || !email.includes('@')){ alert('Please enter a valid email'); return; }
    studentName = name; studentEmail = email;
    answers = Array(questions.length).fill(null);
    shuffleArray(questions);
    startCard.style.display = 'none'; quizCard.style.display = 'block'; currentPage = 0; renderPage(currentPage);
    resultsDiv.style.display = 'none'; exportBtn.style.display = 'none';
    startTimer();
  });

  prevBtn.addEventListener('click', ()=>{ if (currentPage > 0){ currentPage--; renderPage(currentPage); } });
  nextBtn.addEventListener('click', ()=>{ if (currentPage < Math.ceil(questions.length/pageSize)-1){ currentPage++; renderPage(currentPage); } });

  shuffleBtn.addEventListener('click', ()=>{
    shuffleArray(questions);
    answers = Array(questions.length).fill(null);
    currentPage = 0;
    renderPage(currentPage);
    resultsDiv.style.display = 'none'; exportBtn.style.display = 'none';
  });

  themeBtn.addEventListener('click', ()=>{
    document.documentElement.classList.toggle('light');
    themeBtn.textContent = document.documentElement.classList.contains('light') ? '‚òÄÔ∏è Light' : 'üåô Dark';
  });

  function submitQuiz(isAuto=false){
    clearInterval(timerInterval);
    const feedback=[]; let correct=0; const topicStats={};
    for (let i=0;i<questions.length;i++){
      const expected = questions[i].a ? 'true' : 'false';
      const given = answers[i] || null;
      const isCorrect = given === expected;
      if (isCorrect) correct++;
      const t = questions[i].topic || 'General';
      if (!topicStats[t]) topicStats[t] = {total:0,wrong:0};
      topicStats[t].total++; if (!isCorrect) topicStats[t].wrong++;
      feedback.push({i, q: questions[i].q, given, expected, isCorrect});
    }
    const percent = Math.round((correct/questions.length)*100);
    let focusAreas = Object.entries(topicStats).map(([t,v])=>({topic:t,missed:v.wrong,total:v.total})).filter(x=>x.missed>0);
    focusAreas.sort((a,b)=> a.missed - b.missed );
    let html = `<h3>Results ‚Äî ${escapeHtml(studentName)}</h3>`;
    html += `<p><strong>Email:</strong> ${escapeHtml(studentEmail)}</p>`;
    html += `<p><strong>Score:</strong> ${correct} / ${questions.length} (${percent}%)</p>`;
    if (focusAreas.length === 0) html += `<p>Excellent ‚Äî no topic misses detected.</p>`;
    else { html += `<p><strong>Focus areas (weaker topics shown last):</strong></p><ul>`; focusAreas.forEach(f=> html += `<li>${escapeHtml(f.topic)} ‚Äî missed ${f.missed} / ${f.total}</li>`); html += `</ul>`; }
    html += `<h4>Corrections (web only)</h4>`;
    feedback.forEach(f=> html += `<div class="${f.isCorrect?'correct':'wrong'}">Q${f.i+1}. ${escapeHtml(f.q)}<br>Your: ${f.given||'No answer'} | Correct: ${f.expected}</div>`);
    resultsDiv.innerHTML = html; resultsDiv.style.display = 'block'; exportBtn.style.display = 'inline-block';
    window.__tadokk_last_report = { name: studentName, email: studentEmail, score: correct, total: questions.length, percent, focusAreas };
    try{ sendToSheets(window.__tadokk_last_report); }catch(e){ console.warn('Sheets send error', e); }
    setTimeout(()=>{ try{ generateAndDownloadReport(window.__tadokk_last_report); }catch(e){ console.error('Auto-download failed', e); } }, 600);
    if (!isAuto) resultsDiv.scrollIntoView({behavior:'smooth'});
  }

  submitBtn.addEventListener('click', ()=> submitQuiz(false));

  function sendToSheets(report){
    const payload = { name: report.name, email: report.email, score: report.score, percent: report.percent, focusAreas: (report.focusAreas||[]).map(f=>f.topic||f) };
    fetch(SHEET_WEBAPP_URL, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    }).then(r=> r.text().then(t=> console.log('Sheets response', r.status, t)) )
      .catch(err=>{ console.warn('Sheets send failed, fallback no-cors', err); try{ fetch(SHEET_WEBAPP_URL, { method:'POST', mode:'no-cors', body: JSON.stringify(payload) }); }catch(e){} });
  }

  function imageElementToDataUrl(imgEl){
    return new Promise((resolve)=>{
      try {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          try {
            const c = document.createElement('canvas');
            c.width = img.naturalWidth;
            c.height = img.naturalHeight;
            const ctx = c.getContext('2d');
            ctx.drawImage(img,0,0);
            resolve(c.toDataURL('image/png'));
          } catch(e) { console.warn('Canvas draw failed', e); resolve(null); }
        };
        img.onerror = ()=> { console.warn('Could not load image for embedding'); resolve(null); };
        img.src = imgEl.src || 'Tadokkico1.png';
      } catch(e){ console.warn('imageElementToDataUrl error', e); resolve(null); }
    });
  }

  async function generateAndDownloadReport(r){
    if (!window.jspdf){ console.warn('jsPDF not loaded'); return; }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'pt',format:'a4'});
    const brand = [0,86,179];
    doc.setFontSize(18); doc.setTextColor(...brand);
    doc.text('Muscle Physiology Quiz Report',40,60);
    doc.setFontSize(11); doc.setTextColor(0,0,0);
    doc.text(`Name: ${r.name}`,40,86);
    doc.text(`Email: ${r.email}`,40,104);
    doc.text(`Date: ${new Date().toLocaleString()}`,40,122);
    doc.text(`Score: ${r.score} / ${r.total} (${r.percent}%)`,40,140);
    const tableData = (r.focusAreas || []).map(f => [f.topic, `${f.total}`, `${f.missed}`, `${f.total - f.missed}`]);
    let startY = 162;
    if (tableData.length > 0) {
      doc.autoTable({
        startY,
        head: [['Topic','Total Questions','Wrong','Correct']],
        body: tableData,
        theme: 'striped',
        styles: { fontSize: 10 },
        headStyles: { fillColor: brand, textColor: 255, halign: 'center' },
        alternateRowStyles: { fillColor: [230, 245, 255] },
        columnStyles: { 0: { cellWidth: 240 }, 1: { halign: 'center' }, 2: { halign: 'center' }, 3: { halign: 'center' } }
      });
      startY = doc.lastAutoTable.finalY + 10;
    } else {
      doc.text('Focus Areas: None ‚Äî excellent performance.', 40, startY);
    }
    const imgData = await imageElementToDataUrl(document.getElementById('pageLogo'));
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const logoW = 150;
    let logoH = 50;
    if (imgData){
      const tmp = new Image();
      tmp.src = imgData;
      await new Promise((res)=>{ tmp.onload = res; tmp.onerror = res; });
      const ar = (tmp.naturalHeight && tmp.naturalWidth) ? (tmp.naturalHeight / tmp.naturalWidth) : 0.4;
      logoH = Math.max(30, Math.round(logoW * ar));
      try{ doc.addImage(imgData, 'PNG', pageW - logoW - 40, 30, logoW, logoH); }catch(e){ console.warn('addImage failed', e); }
    }
    doc.setDrawColor(...brand); doc.setLineWidth(0.6);
    doc.line(40, pageH - 80, pageW - 40, pageH - 80);
    doc.setFontSize(10); doc.setTextColor(0,0,0);
    doc.text('Powered by Tadokk', 40, pageH - 60);
    const filename = `Tadokk_QuizReport_${sanitizeFilename(r.name)}_${(new Date()).toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`;
    doc.save(filename);
  }

  exportBtn.addEventListener('click', ()=> { const r = window.__tadokk_last_report; if (!r) return alert('Submit first to download your result.'); generateAndDownloadReport(r); });

  renderPage(0);
})(); 
</script>
</body>
</html>